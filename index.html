<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAN CHAI FIRE DASHBOARD</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // =========================================================================
        //  FIREBASE 設定
        // =========================================================================
        const envConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const envAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const envAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const manualConfig = {
            apiKey: "AIzaSyDZfiar_D0bAhlkZFqc_9RqUIO6XTT7UtQ",
            authDomain: "fire-team-dashboard.firebaseapp.com",
            projectId: "fire-team-dashboard",
            storageBucket: "fire-team-dashboard.firebasestorage.app",
            messagingSenderId: "270034667438",
            appId: "1:270034667438:web:cc98aa925e2105fbd4aa3f"
        };

        const firebaseConfig = envConfig || manualConfig;
        const appId = envAppId;

        let db, auth, currentUser;
        let currentYear, currentMonth;
        let eventsCache = {}; // 暫存月曆事件

        async function initApp() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (envAuthToken) {
                    await signInWithCustomToken(auth, envAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        console.log("System Status: Online");
                        initCalendar(); 
                        initRealtimeListeners();
                    }
                });
            } catch (e) {
                console.error("Firebase Init Error:", e);
                alert("系統連線失敗，請檢查網絡");
            }
        }

        initApp();
        
        // --- 天氣功能 ---
        async function fetchWeather() {
            try {
                const response = await fetch('https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=rhrread&lang=tc');
                const data = await response.json();
                const districtTemp = data.temperature.data.find(d => d.place === "香港公園")?.value || data.temperature.data[0].value;
                const iconId = data.icon[0];
                const iconUrl = `https://www.hko.gov.hk/images/HKOWxIconOutline/pic${iconId}.png`;
                
                document.getElementById('weather-temp').innerText = `${districtTemp}°C`;
                document.getElementById('weather-icon').src = iconUrl;
                document.getElementById('weather-desc').innerText = "WAN CHAI";
            } catch (error) {
                console.error("Weather Error", error);
            }
        }
        fetchWeather();
        setInterval(fetchWeather, 1800000);

        // --- 核心功能 ---
        function getCollectionRef(colName) {
             if (envConfig) {
                 return collection(db, 'artifacts', appId, 'public', 'data', colName);
             } else {
                 return collection(db, colName);
             }
        }

        window.checkPass = () => {
            const pass = document.getElementById('access-code').value;
            if (pass === '8888') {
                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
            } else {
                const errorMsg = document.getElementById('error-msg');
                errorMsg.classList.remove('hidden');
                setTimeout(() => errorMsg.classList.add('hidden'), 2000);
            }
        };

        // --- 月曆與更份邏輯 (ROSTER LOGIC) ---
        
        // 計算該日是 A/B/C 邊個 Watch
        // 基準: 2025-12-01 是 A Watch
        function getWatchChar(year, month, day) {
            // Anchor: 2025 Dec 1
            const anchorDate = new Date(2025, 11, 1); 
            anchorDate.setHours(12, 0, 0, 0);

            const targetDate = new Date(year, month, day);
            targetDate.setHours(12, 0, 0, 0);
            
            // 計算相差天數
            const oneDay = 24 * 60 * 60 * 1000;
            const diffTime = targetDate.getTime() - anchorDate.getTime();
            const diffDays = Math.round(diffTime / oneDay);
            
            // 數學 Modulo 處理負數
            let remainder = diffDays % 3;
            if (remainder < 0) remainder += 3;

            if (remainder === 0) return 'A'; // Dec 1 (Diff 0) -> A
            if (remainder === 1) return 'B'; // Dec 2 (Diff 1) -> B
            return 'C';                      // Dec 3 (Diff 2) -> C
        }

        function initCalendar() {
            const date = new Date();
            currentYear = date.getFullYear();
            currentMonth = date.getMonth();
            renderCalendar(currentYear, currentMonth);
        }

        window.changeMonth = (delta) => {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar(currentYear, currentMonth);
        };

        function renderCalendar(year, month) {
            const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
            document.getElementById('month-year-display').innerText = `${monthNames[month]} // ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';

            // [修正] 移除 'hidden md:block'，確保手機版都有空白格，對齊星期
            for (let i = 0; i < firstDay; i++) {
                const blank = document.createElement('div');
                blank.className = "bg-gray-100 border border-gray-300 opacity-50"; 
                grid.appendChild(blank);
            }

            // 日期渲染
            for (let i = 1; i <= daysInMonth; i++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                
                // 獲取更份
                const watchChar = getWatchChar(year, month, i);
                let watchColorClass = "";
                
                if (watchChar === 'A') watchColorClass = "bg-purple-600 text-white border-purple-800";
                if (watchChar === 'B') watchColorClass = "bg-green-600 text-white border-green-800";
                if (watchChar === 'C') watchColorClass = "bg-blue-600 text-white border-blue-800";

                const dayDiv = document.createElement('div');
                dayDiv.className = "relative bg-white border border-gray-400 min-h-[80px] md:h-28 p-1 hover:bg-yellow-50 transition-colors cursor-pointer group flex flex-col justify-between";
                dayDiv.onclick = () => openEventModal(dateKey, watchChar);

                // --- 日期頭部 ---
                const headerDiv = document.createElement('div');
                headerDiv.className = "flex justify-between items-start";

                // 日期數字
                const num = document.createElement('span');
                num.className = "font-mono font-bold text-gray-700 text-sm pl-1";
                num.innerText = i;
                
                // 今日標記
                const today = new Date();
                if (today.getFullYear() === year && today.getMonth() === month && today.getDate() === i) {
                    num.className += " bg-black text-white px-1.5";
                    dayDiv.classList.add("ring-4", "ring-yellow-400", "z-10");
                }

                // Watch Badge (更份)
                const watchBadge = document.createElement('span');
                watchBadge.className = `font-industrial text-xs px-1.5 py-0.5 border ${watchColorClass} shadow-sm`;
                watchBadge.innerText = watchChar;

                headerDiv.appendChild(num);
                headerDiv.appendChild(watchBadge);
                dayDiv.appendChild(headerDiv);

                // --- 事項容器 ---
                const eventContainer = document.createElement('div');
                eventContainer.id = `day-${dateKey}`;
                eventContainer.className = "flex flex-col gap-1 overflow-hidden mt-1";
                
                if (eventsCache[dateKey]) {
                    renderDayEvents(eventContainer, eventsCache[dateKey]);
                }

                dayDiv.appendChild(eventContainer);
                grid.appendChild(dayDiv);
            }
        }

        function renderDayEvents(container, text) {
            container.innerHTML = '';
            if(!text) return;
            const badge = document.createElement('div');
            badge.className = "text-[10px] md:text-xs bg-yellow-300 text-black px-1 font-bold truncate border-l-2 border-black";
            badge.innerText = text;
            container.appendChild(badge);
        }

        window.openEventModal = (dateKey, watchChar) => {
            const eventText = prompt(`[${watchChar}更] 請輸入 ${dateKey} 的事項:`, eventsCache[dateKey] || "");
            if (eventText !== null) {
                saveEvent(dateKey, eventText);
            }
        };

        async function saveEvent(dateKey, text) {
            if (!db || !currentUser) return;
            try {
                const eventsRef = getCollectionRef("calendar_events");
                const docRef = doc(eventsRef, dateKey);
                if (text.trim() === "") {
                    await deleteDoc(docRef);
                } else {
                    await setDoc(docRef, {
                        date: dateKey,
                        text: text,
                        updatedAt: serverTimestamp(),
                        updatedBy: currentUser.uid
                    });
                }
            } catch (e) { console.error("Save Error:", e); }
        }

        function initRealtimeListeners() {
            if (!db) return;

            // Calendar Listeners
            const eventsRef = getCollectionRef("calendar_events");
            onSnapshot(eventsRef, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const data = change.doc.data();
                    const dateKey = change.doc.id;
                    eventsCache[dateKey] = change.type === "removed" ? null : data.text;
                    
                    // 只更新當前顯示月份的 UI
                    const container = document.getElementById(`day-${dateKey}`);
                    if (container) {
                        if (change.type === "removed") container.innerHTML = '';
                        else renderDayEvents(container, data.text);
                    }
                });
            });

            // Notes Listeners
            const notesRef = getCollectionRef("notes");
            const qNotes = query(notesRef, orderBy("createdAt", "desc"));
            onSnapshot(qNotes, (snapshot) => {
                const container = document.getElementById('notes-container');
                container.innerHTML = '';
                if (snapshot.empty) container.innerHTML = '<div class="text-center text-gray-400 font-mono py-4 col-span-1">暫無筆記 // EMPTY</div>';
                snapshot.forEach((docSnap) => {
                    const note = docSnap.data();
                    const id = docSnap.id;
                    const div = document.createElement('div');
                    div.className = "bg-white p-3 border-2 border-gray-800 shadow-[4px_4px_0px_#aaa] relative group";
                    div.innerHTML = `
                        <p class="font-mono text-sm text-gray-800 whitespace-pre-wrap font-bold">${note.text}</p>
                        <div class="mt-2 text-xs text-gray-500 border-t border-gray-200 pt-1 flex justify-between items-center">
                            <span class="bg-gray-200 px-1 text-black font-mono">BY: ${note.author || '同事'}</span>
                            <button onclick="deleteItem('notes', '${id}')" class="text-red-600 font-bold opacity-0 group-hover:opacity-100 hover:underline">DEL</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            });
        }

        window.addNote = async () => {
            const input = document.getElementById('note-input');
            const authorInput = document.getElementById('note-author');
            const text = input.value.trim();
            const author = authorInput.value.trim();
            if (!text || !db) return;
            try {
                const notesRef = getCollectionRef("notes");
                await addDoc(notesRef, {
                    text: text,
                    author: author,
                    createdAt: serverTimestamp(),
                    createdBy: currentUser.uid
                });
                input.value = '';
            } catch (e) { console.error(e); }
        };

        window.deleteItem = async (colName, id) => {
            if(!db || !currentUser) return;
            if(confirm('Confirm Delete?')) {
                try {
                    const colRef = getCollectionRef(colName);
                    await deleteDoc(doc(colRef, id));
                } catch(e) { console.error(e); }
            }
        };
    </script>

    <style>
        body {
            background-color: #d1d5db;
            color: #111;
            background-image: radial-gradient(#9ca3af 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .font-industrial { font-family: 'Black Ops One', cursive; }
        .hazard-stripe {
            background: repeating-linear-gradient(45deg, #b91c1c, #b91c1c 10px, #111 10px, #111 20px);
        }
        .fire-stripe {
            background: repeating-linear-gradient(45deg, #ef4444, #ef4444 10px, #fff 10px, #fff 20px);
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #e5e5e5; }
        ::-webkit-scrollbar-thumb { background: #b91c1c; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center font-mono pb-10">

    <!-- Login -->
    <div id="login-modal" class="fixed inset-0 z-50 bg-neutral-900 flex items-center justify-center p-4">
        <div class="bg-white border-4 border-black p-8 w-full max-w-md shadow-[8px_8px_0px_#b91c1c] relative text-center">
            <div class="hazard-stripe h-4 w-full absolute top-0 left-0 border-b-2 border-black"></div>
            <h1 class="text-3xl font-industrial text-black mt-6 mb-2 tracking-widest uppercase">STATION ACCESS</h1>
            <!-- [修正] 移除 placeholder 內的密碼提示 -->
            <input type="password" id="access-code" placeholder="ENTER CODE" class="w-full bg-gray-100 border-2 border-black text-black font-mono text-center text-xl p-3 mb-4 focus:outline-none focus:border-red-600">
            <button onclick="checkPass()" class="w-full bg-black hover:bg-gray-800 text-white font-bold font-mono py-3 px-4 transition-colors border-2 border-transparent hover:border-red-500">LOGIN >></button>
            <p id="error-msg" class="text-red-600 font-bold mt-4 hidden">ACCESS DENIED</p>
            <div class="hazard-stripe h-4 w-full absolute bottom-0 left-0 border-t-2 border-black"></div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="w-full max-w-[1400px] p-2 md:p-4 hidden animate-fade-in mt-2">
        
        <!-- Header -->
        <header class="bg-white border-4 border-black p-4 md:p-6 mb-6 shadow-[6px_6px_0px_rgba(0,0,0,0.3)] flex flex-col md:flex-row justify-between items-center gap-6 relative overflow-hidden">
            <div class="absolute -left-6 top-0 bottom-0 w-12 fire-stripe opacity-20 transform -skew-x-12"></div>
            <div class="z-10 relative text-center md:text-left">
                <div class="flex items-center justify-center md:justify-start gap-2 mb-1">
                    <span class="bg-red-600 text-white text-xs font-bold px-2 py-0.5 border border-black">HKFSD</span>
                    <span class="bg-black text-yellow-400 text-xs font-bold px-2 py-0.5 border border-black">WAN CHAI</span>
                </div>
                <h1 class="text-4xl md:text-5xl font-industrial text-black tracking-wider leading-tight">WAN CHAI FIRE<br><span class="text-red-700">TEAM DASHBOARD</span></h1>
            </div>
            <div class="z-10 bg-gray-50 border-2 border-black p-2 min-w-[160px] text-center shadow-md">
                <div class="text-[10px] font-bold text-gray-500 border-b border-gray-300 w-full mb-1">CURRENT WEATHER</div>
                <div class="flex items-center justify-center gap-2">
                    <img id="weather-icon" src="" alt="Wx" class="w-8 h-8 object-contain">
                    <div class="text-2xl font-bold text-black font-industrial" id="weather-temp">--°C</div>
                </div>
                <div class="text-[10px] font-bold text-red-700 mt-1" id="weather-desc">LOADING</div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Calendar Section -->
            <section class="lg:col-span-2 bg-white border-4 border-black shadow-[8px_8px_0px_#999]">
                <div class="bg-black p-3 flex justify-between items-center text-white border-b-4 border-black">
                    <h2 class="font-industrial text-xl tracking-wider text-yellow-400">>> DUTY ROSTER</h2>
                    <div class="flex items-center gap-4">
                        <button onclick="changeMonth(-1)" class="hover:text-yellow-400 font-bold text-xl px-2">&lt;</button>
                        <span id="month-year-display" class="font-mono font-bold text-lg min-w-[120px] text-center">LOADING...</span>
                        <button onclick="changeMonth(1)" class="hover:text-yellow-400 font-bold text-xl px-2">&gt;</button>
                    </div>
                </div>
                
                <div class="p-4 bg-gray-50">
                    <!-- Legend -->
                    <div class="flex justify-end gap-3 mb-2 font-mono text-[10px] md:text-xs">
                        <div class="flex items-center gap-1"><span class="w-3 h-3 bg-purple-600 border border-black"></span> A Watch</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 bg-green-600 border border-black"></span> B Watch</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 bg-blue-600 border border-black"></span> C Watch</div>
                    </div>
                    <!-- Week Headers -->
                    <div class="grid grid-cols-7 gap-1 mb-1 text-center">
                        <div class="text-red-700 font-bold font-mono text-sm">SUN</div>
                        <div class="font-bold font-mono text-sm">MON</div>
                        <div class="font-bold font-mono text-sm">TUE</div>
                        <div class="font-bold font-mono text-sm">WED</div>
                        <div class="font-bold font-mono text-sm">THU</div>
                        <div class="font-bold font-mono text-sm">FRI</div>
                        <div class="font-bold font-mono text-sm">SAT</div>
                    </div>
                    <!-- Grid -->
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1 bg-gray-200 border border-gray-300 p-1"></div>
                </div>
            </section>

            <!-- Notes Section -->
            <section class="bg-white border-4 border-black shadow-[8px_8px_0px_#999] flex flex-col h-full max-h-[600px] lg:max-h-full">
                <div class="bg-red-700 p-3 flex justify-between items-center text-white border-b-4 border-black">
                    <h2 class="font-industrial text-xl tracking-wider text-white">>> FIELD NOTES</h2>
                    <span class="text-xs font-mono bg-black px-2 py-1">MEMO</span>
                </div>
                <div class="p-4 bg-gray-100 flex-1 flex flex-col overflow-hidden">
                    <div class="bg-white p-3 border-2 border-gray-400 mb-4 shadow-sm shrink-0">
                        <input type="text" id="note-author" placeholder="你的名字 / Callsign" class="bg-transparent border-b border-gray-300 text-black font-bold text-xs w-full mb-2 focus:outline-none focus:border-red-600">
                        <textarea id="note-input" placeholder="輸入備忘 / 交更事項..." rows="2" class="w-full bg-transparent text-black font-mono text-sm focus:outline-none resize-none placeholder-gray-400"></textarea>
                        <button onclick="addNote()" class="w-full mt-2 text-xs bg-black hover:bg-gray-800 text-white py-2 font-mono font-bold uppercase border-2 border-transparent hover:border-yellow-400 transition-all">Add Note</button>
                    </div>
                    <div id="notes-container" class="space-y-3 overflow-y-auto pr-1 custom-scroll flex-1"></div>
                </div>
            </section>
        </div>

        <footer class="mt-8 text-center pb-8">
            <p class="font-mono text-[10px] text-gray-500 bg-white inline-block px-4 py-1 border border-gray-300">WAN CHAI FIRE STATION // SYSTEM VER 3.5</p>
        </footer>
    </div>
</body>
</html>
